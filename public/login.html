<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>ë¡œê·¸ì¸ â€” ì‚¬ì¥ë‹˜AI</title>
  <link rel="stylesheet" href="/css/login.css">
</head>
<body>
  <main class="login-container">
    <div class="login-card">
      <div class="logo">ğŸª</div>
      <h1>ì‚¬ì¥ë‹˜AI</h1>
      <p class="subtitle">ë¡œê·¸ì¸í•˜ì„¸ìš”</p>

      <div class="social-buttons">
        <button type="button" class="btn-kakao" id="btn-kakao" aria-label="ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸">
          <span class="icon-kakao">ğŸ’¬</span>
          ì¹´ì¹´ì˜¤ë¡œ ì‹œì‘í•˜ê¸°
        </button>
        <button type="button" class="btn-google" id="btn-google" aria-label="êµ¬ê¸€ ë¡œê·¸ì¸">
          <svg width="18" height="18" viewBox="0 0 18 18" aria-hidden="true">
            <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.252-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
            <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z"/>
            <path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/>
            <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.27C4.672 5.14 6.656 3.58 9 3.58z"/>
          </svg>
          êµ¬ê¸€ë¡œ ì‹œì‘í•˜ê¸°
        </button>
      </div>

      <div class="divider"><span>ë˜ëŠ”</span></div>

      <form class="email-form" id="email-form" method="post" action="javascript:void(0)">
        <div class="form-group">
          <label for="email" class="sr-only">ì´ë©”ì¼</label>
          <input type="email" id="email" name="email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" required autocomplete="email">
        </div>
        <div class="form-group">
          <label for="password" class="sr-only">ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required autocomplete="current-password">
        </div>
        <button type="submit" class="btn-submit" id="btn-submit">ë¡œê·¸ì¸</button>
      </form>

      <div class="signup-link">
        ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?
        <a href="javascript:void(0)" id="btn-signup" role="button">íšŒì›ê°€ì…</a>
      </div>

      <div class="error-message" id="error-message" role="alert" aria-live="polite"></div>
    </div>
  </main>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ë¡œê·¸ì¸ ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ â€” auth.js ë¶ˆí•„ìš” -->
  <script>
    (function() {
      function log(msg) {
        console.log('[login]', msg);
      }

      function showError(msg) {
        var el = document.getElementById('error-message');
        if (el) { el.textContent = msg; el.classList.add('show'); }
        log('ERROR: ' + msg);
      }

      log('ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘');

      // Supabase í´ë¼ì´ì–¸íŠ¸
      var sb = null;
      async function getClient() {
        if (sb) return sb;
        try {
          log('config ë¡œë“œ ì¤‘...');
          var cfg = await fetch('/api/config').then(function(r) { return r.json(); });
          sb = window.supabase.createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);
          log('Supabase ì´ˆê¸°í™” ì™„ë£Œ');
          return sb;
        } catch(e) {
          showError('ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + e.message);
          return null;
        }
      }

      var isSignupMode = false;
      var params = new URLSearchParams(location.search);
      var returnUrl = params.get('returnUrl') || '/index.html';

      // ì—ëŸ¬ íŒŒë¼ë¯¸í„° ì²˜ë¦¬
      if (params.get('error')) showError(decodeURIComponent(params.get('error')));

      // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸
      document.getElementById('btn-kakao').addEventListener('click', async function() {
        log('ì¹´ì¹´ì˜¤ í´ë¦­');
        var client = await getClient();
        if (!client) return;
        var result = await client.auth.signInWithOAuth({
          provider: 'kakao',
          options: { redirectTo: window.location.origin + '/index.html' }
        });
        if (result.error) showError('ì¹´ì¹´ì˜¤ ì˜¤ë¥˜: ' + result.error.message);
      });

      // êµ¬ê¸€ ë¡œê·¸ì¸
      document.getElementById('btn-google').addEventListener('click', async function() {
        log('êµ¬ê¸€ í´ë¦­');
        var client = await getClient();
        if (!client) return;
        var result = await client.auth.signInWithOAuth({
          provider: 'google',
          options: { redirectTo: window.location.origin + '/index.html' }
        });
        if (result.error) showError('êµ¬ê¸€ ì˜¤ë¥˜: ' + result.error.message);
      });

      // ì´ë©”ì¼ í¼
      document.getElementById('email-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        var email = document.getElementById('email').value.trim();
        var pass = document.getElementById('password').value;
        if (!email || !pass) { showError('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

        var btn = document.getElementById('btn-submit');
        btn.disabled = true;
        btn.textContent = isSignupMode ? 'ê°€ì… ì¤‘...' : 'ë¡œê·¸ì¸ ì¤‘...';
        log((isSignupMode ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸') + ' ì‹œë„: ' + email);

        var client = await getClient();
        if (!client) { btn.disabled = false; btn.textContent = isSignupMode ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸'; return; }

        try {
          if (isSignupMode) {
            var r = await client.auth.signUp({ email: email, password: pass,
              options: { emailRedirectTo: window.location.origin + '/login.html' } });
            if (r.error) throw r.error;
            if (r.data.user && !r.data.session) {
              showError('ì¸ì¦ ì´ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. í™•ì¸ í›„ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            } else {
              location.href = decodeURIComponent(returnUrl);
            }
          } else {
            var r = await client.auth.signInWithPassword({ email: email, password: pass });
            if (r.error) throw r.error;
            log('ë¡œê·¸ì¸ ì„±ê³µ! ì´ë™ ì¤‘...');
            location.href = decodeURIComponent(returnUrl);
          }
        } catch(err) {
          var msgs = {
            'Invalid login credentials': 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤',
            'Email not confirmed': 'ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤',
            'User already registered': 'ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤',
            'Password should be at least 6 characters': 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤'
          };
          showError(msgs[err.message] || err.message);
        }
        btn.disabled = false;
        btn.textContent = isSignupMode ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸';
      });

      // íšŒì›ê°€ì…/ë¡œê·¸ì¸ ëª¨ë“œ ì „í™˜
      document.getElementById('btn-signup').addEventListener('click', function(e) {
        e.preventDefault();
        isSignupMode = !isSignupMode;
        document.getElementById('btn-submit').textContent = isSignupMode ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸';
        document.getElementById('btn-signup').textContent = isSignupMode ? 'ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°' : 'íšŒì›ê°€ì…';
        log('ëª¨ë“œ: ' + (isSignupMode ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸'));
      });

      log('ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ âœ…');

      // ì´ë¯¸ ë¡œê·¸ì¸ëœ ê²½ìš° í™ˆìœ¼ë¡œ
      setTimeout(async function() {
        var client = await getClient();
        if (!client) return;
        try {
          var s = await client.auth.getSession();
          if (s.data && s.data.session) {
            log('ê¸°ì¡´ ì„¸ì…˜ ë°œê²¬, í™ˆìœ¼ë¡œ ì´ë™');
            location.href = decodeURIComponent(returnUrl);
          }
        } catch(e) {}
      }, 500);

    })();
  </script>
</body>
</html>
